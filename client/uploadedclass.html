<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <link rel="stylesheet" text="text/css" href="assets/css/uploadedclass.css">
  <link rel="stylesheet" text="text/css" href="assets/css/all.css">
  <title>課程資訊修改</title>
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
</head>

<body>

  <div id="header"></div>
  <div>
    Account:<span id="Acc"></span>
  </div>
  <script>
    const openAcc = sessionStorage.getItem('Acc');
    document.getElementById('Acc').textContent = openAcc;
    
    const openName = sessionStorage.getItem('open');
  
  </script>
  <div class="container">
      <div class="row">
        <div class="h4 FirstuserTitle">
          <span class="userTitleSpan caca">課程資料</span>
        </div>
        <div class="col-6 classpic">
          <!-- 課程圖片 --------------------------------------->
          <!-- <form action="" enctype="multipart/form-data"> -->
            <label id="extlab"></label> <br><br>
            <img id="img" class="insideclasspic" src="assets/image/chosePhoto.png"/> <label id="upprogress"></label> <br><br>
            <div class="downbtn">
              <button id="selbtn">請選擇檔案</button>
              <label>Image Name</label>
              <input type="text" id="namebox" >
            </div>
          <!-- <div class="usetomargin">
            <a href="javascript:;" class="a-upload">
              <input type="file" onchange="readURL(this)" targetID="preview_progressbarTW_img" value="上傳課程圖片"
                accept="image/gif, image/jpeg, image/png" />
            </a>
          </div> -->
          <!-- </form> -->
          <!-- <script>
            function readURL(input) {
              if (input.files && input.files[0]) {
                var imageTagID = input.getAttribute("targetID");
                var reader = new FileReader();
                reader.onload = function (e) {
                  var img = document.getElementById(imageTagID);
                  img.setAttribute("src", e.target.result)
                }
                reader.readAsDataURL(input.files[0]);
              }
            }
          </script> -->
          <!-- <img src="https://picsum.photos/300/200/?random=10" class="rounded mx-auto d-block" alt="..."> -->
        </div>
        <div class="col-6">
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default">課程名稱:</span>
            <input readonly="readonly" id="ClassName" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" >
          </div>
          <script>
             const class123 = localStorage.getItem('ClassName');
              document.getElementById('ClassName').value = class123;
              console.log(class123);
          </script>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default1">講師:</span>
            <input readonly="readonly" id="classteacher" type="text" class="form-control"
              aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" >
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text"  id="inputGroup-sizing-default">課程所屬類別:</span>
                <div class="aaaaa">
                  <div class="form-check form-check-inline">
                        <select id="classcategory" required disabled>
                                <option selected>請選擇</option>
                                <option value="專業課程">專業課程</option>
                                <option value="專業品質">專業品質</option>
                                <option value="專業倫理">專業倫理</option>
                                <option value="專業法規">專業法規</option>
                        </select>
                  </div>
                </div>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default3">開課單位:</span>
            <input readonly="readonly" id="open" type="text" class="form-control" aria-label="Sizing example input"
              aria-describedby="inputGroup-sizing-sm">
              <script>
                const openname = sessionStorage.getItem('open');
                document.getElementById('open').value = openname;
              </script>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default4">上課日期:</span>
                <span class="input-group-text" id="inputGroup-sizing-default0">開始上課:</span>
                <input readonly="readonly" type="date" class="form-control" aria-label="Sizing example input"aria-describedby="inputGroup-sizing-sm" id="classdate">
                <span class="input-group-text" id="inputGroup-sizing-default50">結束上課:</span>
                <input readonly="readonly" type="date" class="form-control" aria-label="Sizing example input"aria-describedby="inputGroup-sizing-sm" id="classend">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="h4 FirstuserTitle babala">
          <span class="userTitleSpan caca">課程資訊</span>
        </div>
        <div class="col">
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default5">上課方式:</span>
            <input readonly="readonly" id="way" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default6">上課地點:</span>
            <input readonly="readonly" id="place" type="text" class="form-control" aria-label="Sizing example input"
              aria-describedby="inputGroup-sizing-sm">
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default96">課程費用:</span>
            <input readonly="readonly" type="number" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="charge">
          </div> 
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default4">報名時間:</span>
                <span class="input-group-text" id="inputGroup-sizing-default0">開始報名:</span>
                <input readonly="readonly" type="date" class="form-control" aria-label="Sizing example input"aria-describedby="inputGroup-sizing-sm" id="registration">
                <span class="input-group-text" id="inputGroup-sizing-default50">結束報名:</span>
                <input readonly="readonly" type="date" class="form-control" aria-label="Sizing example input"aria-describedby="inputGroup-sizing-sm" id="joinend">
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default8">課程規定人數:</span>
            <input readonly="readonly" id="numofpeople" type="text" class="form-control"
              aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text" id="inputGroup-sizing-default9">繳費方式:</span>
          </div>
          <div class="input-group mb-3">
            <span class="input-group-text card" id="inputGroup-sizing-default0">銀行代碼:</span>
            <input readonly="readonly" id="bankcode" type="text" class="form-control bank"
              aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
            <span class="input-group-text card" id="inputGroup-sizing-default11">銀行帳號:</span>
            <input readonly="readonly" id="bankaccount" type="text" class="form-control bank"
              aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
            <span class="input-group-text card" id="inputGroup-sizing-default12">銀行戶名:</span>
            <input readonly="readonly" id="bankname" type="text" class="form-control bank"
              aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
          </div>
        </div>
        <div class="row">
          <div class="h4 FirstuserTitle babala">
            <span class="userTitleSpan caca">課程目的</span>
          </div>
          <div class="form-group green-border-focus">
            <textarea readonly="readonly" id="classpurpose" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="h4 FirstuserTitle babala">
            <span class="userTitleSpan caca">積分認證</span>
          </div>
          <div class="myselfdo">
            <p class="bonusnumber">積分數:</p><input readonly="readonly" id="point" type="text" class="textnumber">
          </div>
          <div class="form-group green-border-focus">
            <textarea readonly="readonly" id="pointcontent" class="pointcontent form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="h4 FirstuserTitle babala">
            <span class="userTitleSpan caca">注意事項</span>
          </div>
          <div class="form-group green-border-focus">
            <textarea readonly="readonly" id="precautions" class="precautions form-control" rows="5"></textarea>
          </div>
        </div>
        <div class="row shelfclassbtns">
          <!-- 吳老師說要加的 -->
          <button id="confirm" type="submit" class="shelfclassbtn2 btn btn-info">
            <!-- <input type="submit" value="確定修改"> -->
            <div>確定修改</div>
          </button>
          <button id="editbtn" type="button" class="shelfclassbtn2 btn btn-info" onclick="editClass()">
            <div>編輯資料</div>
          </button>
        </div>

      </div>
  </div>
  <div id="footer"></div>

  <script>
    $(function () {
      $("#header").load("h3.html")
      $("#footer").load("footer.html")
    });

    // 編輯課程資料
    function editClass() {
      $('.usetomargin').css({
        'display': 'flex'
      })
      $('#confirm').css({
        'display': 'flex'
      })
      $('#editbtn').css({
        'display': 'none'
      })
      $('#classcategory').removeAttr("disabled");
      $('#classdate').removeAttr("readonly");
      $('#classend').removeAttr("readonly");
      $('#joinend').removeAttr("readonly");
      $('#charge').removeAttr("readonly");
      $('#classteacher').removeAttr("readonly");
      // $('#classcategory').removeAttr("readonly");
      $('#classdate').removeAttr("readonly");
      $('#way').removeAttr("readonly");
      $('#place').removeAttr("readonly");
      $('#registration').removeAttr("readonly");
      $('#numofpeople').removeAttr("readonly");
      $('#bankcode').removeAttr("readonly");
      $('#bankaccount').removeAttr("readonly");
      $('#bankname').removeAttr("readonly");
      $('#classpurpose').removeAttr("readonly");
      $('#point').removeAttr("readonly");
      $('.pointcontent').removeAttr("readonly");
      $('.precautions').removeAttr("readonly");
    }
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
    integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js"
    integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous">
  </script>

  <!--firebase-->
    <script type="module">
      // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
    apiKey: "AIzaSyBxyo9c07rd1CzGXbEnu9jmutXAbIBiHis",
    authDomain: "contactform-d7d05.firebaseapp.com",
    databaseURL: "https://contactform-d7d05-default-rtdb.firebaseio.com",
    projectId: "contactform-d7d05",
    storageBucket: "contactform-d7d05.appspot.com",
    messagingSenderId: "371807550240",
    appId: "1:371807550240:web:5a7fb2cd0674cd8f4bb545"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    //Storage
    import{getStorage, ref as sRef, uploadBytesResumable, getDownloadURL}
    from "firebase/firestore";

    import{
    getFirestore, doc, setDoc, collection, addDoc, getDoc,updateDoc,deleteDoc
    }
    from "firebase/firestore";

    const db = getFirestore();

      //抓ID值
      let imgsrc = document.getElementById("img");
      let classunit = document.getElementById("classname");
      let teacher = document.getElementById("classteacher");
      let classtype = document.getElementById("classcategory");//要改選單
      let charge = document.getElementById("charge");//沒有費用
      let openclass = document.getElementById("classuint");
      let classdate = document.getElementById("classdate");
      let classend = document.getElementById("classend");//沒有結束日期
      let how = document.getElementById("way");
      let place = document.getElementById("place");
      let joindate = document.getElementById("registration");
      let joindateend = document.getElementById("joinend");//沒有報名結束
      let people = document.getElementById("numofpeople");
      let bank = document.getElementById("bankcode");
      let bankacc = document.getElementById("bankaccount");
      let bankname = document.getElementById("bankname");
      let purpose = document.getElementById("classpurpose");
      let credit = document.getElementById("point");
      let auth = document.getElementById("pointcontent");
      let note = document.getElementById("precautions");
   
      //get剩下的值
    async function get(){
        var ref = doc(db,"上傳課程資料", class123);
        const docSnap = await getDoc(ref);

        if(docSnap.exists()){
            imgsrc.src = docSnap.data().ImageURL;
            teacher.value = docSnap.data().講師;
            classtype.value = docSnap.data().課程所屬類別;
            charge.value = docSnap.data().課程費用;
            classdate.value = docSnap.data().開始上課;
            classend.value = docSnap.data().結束上課;
            how.value = docSnap.data().上課方式;
            place.value = docSnap.data().上課地點;
            joindate.value = docSnap.data().報名時間;
            joindateend.value = docSnap.data().報名結束;
            people.value = docSnap.data().課程規定人數;
            bank.value = docSnap.data().銀行代碼;
            bankacc.value = docSnap.data().銀行帳號;
            bankname.value = docSnap.data().銀行戶名;
            purpose.value = docSnap.data().課程目的;
            credit.value = docSnap.data().積分數;
            auth.value = docSnap.data().積分認證;
            note.value = docSnap.data().注意事項;
        }
        else{
            alert("No such Document");
        }
      }

      let confirm = document.getElementById("confirm");
      var files = [];
      var reader = new FileReader();


var namebox = document.getElementById('namebox');
var extlab = document.getElementById('extlab');
var proglab = document.getElementById('upprogress');
var selBtn = document.getElementById('selbtn');
//var UpBtn = document.getElementById('upbtn');

var input = document.createElement('input');
input.type = 'file';

input.onchange = e=>{
    files = e.target.files;

    var extention = GetFileExt(files[0]);
    var name = GetFileName(files[0]);

    namebox.value = name;
    extlab.innerHTML = extention;

    reader.readAsDataURL(files[0]);
}


reader.onload = function(){
  imgsrc.src = reader.result;
}

//select
selBtn.onclick = function(){
    input.click();
}

function GetFileExt(file){
    var temp = file.name.split('.');
    var ext = temp.slice((temp.length-1),(temp.length));
    return '.' + ext[0];
}

function GetFileName(file){
    var temp = file.name.split('.');
    var ext = temp.slice(0,-1).join('.');
    return ext;
}
//upload process
//
async function UploadProcess(){
    var ImgUpload = files[0];

    var ImgName = namebox.value + extlab.innerHTML;

    const metaData = {
        contentType:ImgUpload.type
    }
    const storage = getStorage();

    const storageRef = sRef(storage, "Images/"+ImgName);

    const UploadTask = uploadBytesResumable(storageRef, ImgUpload, metaData);

    UploadTask.on('state-changed', (snapshot)=>{
        var progess = (snapshot.bytesTransferred / snapshot.totalBytes) *100;
        proglab.innerHTML = "Upload" + progess +"%";
    },
    (error)=>{
        alert("error:image not upload!");
    },
    ()=>{
        getDownloadURL(UploadTask.snapshot.ref).then((downloadURL)=>{
            SaveURLtoFirestore(downloadURL);
        });
    }
    );
}

      //update data
    async function updateclassdata(url){
      var name = namebox.value;
      var ext = extlab.innerHTML;
            var ref = doc(db,"上傳課程資料", class123);

            await updateDoc(
                ref,{
                  ImageName: (name+ext),
                  ImageURL: imgsrc.src,
                  講師 : teacher.value,
                  課程所屬類別 : classtype.value,
                  課程費用 : charge.value,
                  開始上課 : classdate.value,
                  結束上課 : classend.value,
                  上課方式 : how.value,
                  上課地點 : place.value,
                  報名時間 : joindate.value,
                  報名結束 : joindateend.value,
                  課程規定人數 : people.value,
                  銀行代碼 : bank.value,
                  銀行帳號 : bankacc.value,
                  銀行戶名 : bankname.value,
                  課程目的 : purpose.value,
                  積分數 : credit.value,
                  積分認證 : auth.value,
                  注意事項 : note.value              
                    }
            )
            .then(()=>{
            alert("課程資料更新成功!!");
            window.location.reload();
            })
            .catch((error)=>{
                alert("Unsuccessful operation, error"+error);
            });
        }
        
        confirm.addEventListener("click",(e) =>{
        e.preventDefault();
        updateclassdata();
      });

      window.onload = get();

</script>
</body>

</html>