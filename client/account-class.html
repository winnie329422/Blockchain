<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>積分管家</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../client/assets/css/admin-openclassData.css">
</head>

<body>
    <!-- 新增承辦人員 -->
    <!-- Modal -->
    <div class="modal modal-dialog-scrollable fade" id="NEWstaticBackdrop" data-bs-backdrop="static"
        data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="NEWstaticBackdropLabel">新增承辦人員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="">
                    <div class="modal-body">
                        <div class="addLine"><label>承辦人員姓名：</label>
                            <input class="FControl" type="text" id="person" required></div>
                        <div class="addLine"><label>電子郵件：</label><input class="FControl" id="personemail" type="email" required></div>
                        <div class="addLine"><label>職稱：</label><input class="FControl" type="text" id="personjob" required></div>
                        <div class="addLine"><label>電話：</label><input class="FControl" type="text" id="personphone" required></div>
                        <div class="addLine"><label>帳號：</label><input class="FControl" type="text" id="personaccount" required></div>
                        <div class="addLine"><label>密碼：</label><input class="FControl" type="text" id="personpassword" required></div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="addOCpersonBtn" id="addbtn" value="確定新增">
                        <button class="addOCpersonBtn" type="button" id="upbtn">修改</button>
                        <button class="addOCpersonBtn" type="button" id="stopbtn">停用</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- 新增承辦人員END -->
    <!-- 編輯承辦人員 -->
    <!-- Modal -->
    <!-- <div class="modal modal-dialog-scrollable fade" id="staticBackdrop" data-bs-backdrop="static"
        data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">編輯承辦人員</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="">
                    <div class="modal-body">
                        <div class="addLine"><label>承辦人員姓名：</label>
                            <input class="FControl" type="text" required placeholder="黃小曼"></div>
                        <div class="addLine"><label>電子郵件：</label><input class="FControl" type="email" required
                                placeholder="man@gmail.com">
                        </div>
                        <div class="addLine"><label>職稱：</label><input class="FControl" type="text" required
                                placeholder="行政助理">
                        </div>
                        <div class="addLine"><label>電話：</label><input class="FControl" type="text" required
                                placeholder="0987654321"></div>

                        <div class="addLine"><label>帳號：</label><input class="FControl" type="text" required
                                placeholder="man123">
                        </div>
                        <div class="addLine"><label>密碼：</label><input class="FControl" type="text" required
                                placeholder="123456789">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type="submit" class="addOCpersonBtn" value="儲存">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div> -->
    <!-- 編輯承辦人員END -->
    <div id="header"></div>
    <!--test-->
  <div>
    Account:<span id="Acc"></span>
  </div>
  <script>
    const openAcc = sessionStorage.getItem('Acc');
  
    document.getElementById('Acc').textContent = openAcc;
  </script>
    <div class="container justify-content-center" id="allClass">
        <div id="allclass">
            <!-- <h4 class="adminTitle">社團法人臺中市紅十字會</h4>
            <div class="OCcontent">
                <div class="row">
                    <div class="col-5">
                        <p>負責人：<input type="text" readonly="readonly" id="name" class="MM FControl" value="黃小曼">
                        </p>
                        <p>地址：<input type="text" readonly="readonly" id="address" class="MM FControl" value="台中"></p>
                        <p>電話：<input type="text" readonly="readonly" id="phone" class="MM FControl" value="04-25565880">
                        </p>
                        <p>傳真：<input type="text" readonly="readonly" id="fax" class="MM FControl" value="04-25564506">
                        </p>
                        <p>電子郵件：<input type="email" readonly="readonly" id="mail" class="MM FControl"
                                value="ltc.pa@msa.hinet.net">
                        </p>
                        <p>備註：<input type="text" readonly="readonly" id="memo" class="MM FControl" value="無">
                        </p>
                    </div>
                    <div class="col-4">
                        <p>銀行代碼：<input type="text" readonly="readonly" id="code" class="MM FControl" value="700"></p>
                        <p>銀行帳號：<input type="text" readonly="readonly" id="account" class="MM FControl"
                                value="1234567891011"></p>
                    </div>
                    <div class="col-3">
                        <button id="ed" class="adminOpenClassEditBtn" type="button" onclick="edit()">編輯</button>
    
                        <input id="submit" type="submit" value="儲存">
                    </div>
                </div> -->
        </div>
        <!-- 開課單位資料 -->
        
            <!-- 承辦人員資料 -->
            <div class="row">
                <div class="OCperson">
                    <p class="adminInsideTitle">承辦人員</p>
                    <button class="adddPerson" data-bs-toggle="modal" data-bs-target="#NEWstaticBackdrop"
                        type="button"  onclick="FillTboxes(null)">新增</button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead style="border: solid black 1px;">
                            <tr style="background-color: #FFBC1D;">
                                <th scope="col">項次</th>
                                <th scope="col">承辦人員</th>
                                <th scope="col">電子郵件</th>
                                <th scope="col">帳號</th>
                                <th scope="col">職稱</th>
                                <th scope="col">電話</th>
                                <th scope="col">密碼</th>
                                <th scope="col">編輯/刪除</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1">
                            <!-- <tr>
                                <th scope="row">1</th>
                                <td>林小魚</td>
                                <td>man@gmail.com</td>
                                <td>man123</td>
                                <td>行政助理</td>
                                <td>0987654321</td>
                                <td>********</td>
                                <td> <button class="adminOpenClassEditBtn" data-bs-toggle="modal"
                                        data-bs-target="#staticBackdrop" type="button">編輯</button>
                                    <button class="adminOpenClassDelBtn" type="button">停用</button></td>
                            </tr>
                            <tr>
                                <th scope="row">2</th>
                                <td>黃小曼</td>
                                <td>man@gmail.com</td>
                                <td>man123</td>
                                <td>行政助理</td>
                                <td>0987654321</td>
                                <td>********</td>
                                <td> <button class="adminOpenClassEditBtn" data-bs-toggle="modal"
                                        data-bs-target="#staticBackdrop" type="button">編輯</button>
                                    <button class="adminOpenClassDelBtn" type="button">停用</button></td>
                            </tr>
                            <tr>
                                <th scope="row">3</th>
                                <td>劉小淳</td>
                                <td>man@gmail.com</td>
                                <td>man123</td>
                                <td>行政助理</td>
                                <td>0987654321</td>
                                <td>********</td>
                                <td> <button class="adminOpenClassEditBtn" data-bs-toggle="modal"
                                        data-bs-target="#staticBackdrop" type="button">編輯</button>
                                    <button class="adminOpenClassDelBtn" type="button">停用</button></td>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="footer"></div>
    <script>
        $(function () {
            $("#header").load("h3.html")
            $("#footer").load("footer.html")
        });
        // 編輯開課單位資料
        function edit() {
            $('.MM').css({
                'border-width': '1px',
                'padding': '0.375rem 2.25rem 0.375rem 0.75rem',
                'border-radius': '0.375rem',
            });
            // $('.FControl').css({
            //   'border-color': '#ced4da'
            // });

            // $('.M-password').css({
            //   'display': 'flex'
            // })
            $('#submit').css({
                'display': 'flex'
            })
            $('#ed').css({
                'display': 'none'
            })
            $('#del').css({
                'display': 'none'
            })
            $('#name').removeAttr("readonly");
            $('#address').removeAttr("readonly");
            $('#phone').removeAttr("readonly");
            $('#fax').removeAttr("readonly");
            $('#mail').removeAttr("readonly");
            $('#memo').removeAttr("readonly");
            $('#code').removeAttr("readonly");
            $('#account').removeAttr("readonly");
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
        integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js"
        integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous">
    </script>
    <!--Firebase-->
<script type="module">
    //import
    import { initializeApp } from "firebase/app";
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
    
            // Your web app's Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBxyo9c07rd1CzGXbEnu9jmutXAbIBiHis",
                authDomain: "contactform-d7d05.firebaseapp.com",
                databaseURL: "https://contactform-d7d05-default-rtdb.firebaseio.com",
                projectId: "contactform-d7d05",
                storageBucket: "contactform-d7d05.appspot.com",
                messagingSenderId: "371807550240",
                appId: "1:371807550240:web:5a7fb2cd0674cd8f4bb545"
            };
    
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            import{
                getFirestore, doc, getDoc, getDocs, collection, onSnapshot, updateDoc,setDoc,deleteDoc,where,query
            }
            from "firebase/firestore";
    
            const db = getFirestore();
  
            const openName = sessionStorage.getItem('open');
      
            
     async function storedata()
    {
        const ref = collection(db, "申請中-開課單位資料");
        const q = query(ref,where('開課單位名稱','==',openName));
        const querySnapshot = await getDocs(q);

        var stdNo=0;
    querySnapshot.forEach(function(element)
    {
      
        document.querySelector('#allclass').innerHTML+=`
        <h4 class="adminTitle">${element.data().開課單位名稱}</h4>
            <div class="OCcontent">
                <div class="row">
                    <div class="col-5">
                        <p>負責人：<input type="text" readonly="readonly" id="name" class="MM FControl" value="${element.data().負責人}">
                        </p>
                        <p>縣市：<input type="text" readonly="readonly" id="country" class="MM FControl" value="${element.data().縣市}"></p>
                        <p>地址：<input type="text" readonly="readonly" id="address" class="MM FControl" value="${element.data().地址}"></p>
                        <p>電話：<input type="text" readonly="readonly" id="phone" class="MM FControl" value="${element.data().聯絡電話}">
                        </p>
                        <p>傳真：<input type="text" readonly="readonly" id="fax" class="MM FControl" value="${element.data().傳真}">
                        </p>
                        <p>電子郵件：<input type="email" readonly="readonly" id="mail" class="MM FControl"
                                value="${element.data().電子郵件}">
                        </p>
                        <p>備註：<input type="text" readonly="readonly" id="memo" class="MM FControl" value="${element.data().備註}">
                        </p>
                    </div>
                    <div class="col-4">
                        <p>銀行代碼：<input type="text" readonly="readonly" id="code" class="MM FControl" value="${element.data().銀行代碼}"></p>
                        <p>銀行帳號：<input type="text" readonly="readonly" id="account" class="MM FControl"
                                value="${element.data().銀行帳號}"></p>
                    </div>
                    <div class="col-3">
                        <button id="ed" class="adminOpenClassEditBtn" type="button" onclick="edit()">編輯</button>
    
                        <input id="submit" type="submit" value="儲存" >
                    </div>
                </div>`      
         });  
         
    let name = document.getElementById('name');
    let country = document.getElementById('country');
    let address = document.getElementById('address');
    let phone = document.getElementById('phone');
    let fax = document.getElementById('fax');
    let mail = document.getElementById('mail');
    let memo = document.getElementById('memo');
    let code = document.getElementById('code');
    let account = document.getElementById('account');

    let save = document.getElementById('submit');
    async function update(){
            var ref = doc(db,"申請中-開課單位資料", openName);

            await updateDoc(
                ref,{
                    縣市 : country.value,
                    地址 : address.value,
                    聯絡電話 : phone.value,
                    傳真 : fax.value,
                    電子郵件 : mail.value,
                    備註 : memo.value,
                    銀行代碼 : code.value,
                    銀行帳號 : account.value               
                }
            )
            .then(()=>{
            alert("修改成功");
            window.location.reload();
            
            })
            .catch((error)=>{
                alert("Unsuccessful operation, error"+error);
            });
        }
        save.addEventListener("click",(e) =>{
        e.preventDefault();
        update();
    });
    };
    
  //新增表單裡的textbox
  let name1 = document.getElementById("person");
  let mail1 = document.getElementById("personemail");
  let job1 = document.getElementById("personjob");
  let tele1 = document.getElementById("personphone");
  let acc1 = document.getElementById("personaccount");
  let pass1 = document.getElementById("personpassword");
  
  //button
  let SetBtn = document.getElementById("addbtn");
  let UpBtn = document.getElementById("upbtn");
  let DelBtn = document.getElementById("stopbtn");
    //filling the table
            var stdNo = 0;
            var tbody = document.getElementById('tbody1');
            var stdList = [];
    
            function AddItemToTable(name, mail, account, job, phone, password){
                let tr = document.createElement("tr");
                let td1 = document.createElement("td");
                let td2 = document.createElement("td");
                let td3 = document.createElement("td");
                let td4 = document.createElement("td");
                let td5 = document.createElement("td");
                let td6 = document.createElement("td");
                let td7 = document.createElement("td");
                let Control = document.createElement("td");

                stdList.push([name, mail, account, job, phone, password]);

    
                td1.innerHTML= ++stdNo;
                td2.innerHTML= name;
                td3.innerHTML= mail;
                td4.innerHTML= account;
                td5.innerHTML= job;
                td6.innerHTML= phone;
                td7.innerHTML= password;
                Control.innerHTML= '<button class="adminOpenClassEditBtn my-2" data-bs-toggle="modal" data-bs-target="#NEWstaticBackdrop" onclick="FillTboxes('+stdNo+')">編輯</button>';

                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tr.appendChild(td5);
                tr.appendChild(td6);
                tr.appendChild(td7);
                tr.appendChild(Control);
    
                tbody.appendChild(tr);
            }
    
            function AddAllItemsToTable(TheStudent){
                document.getElementById('tbody1').innerHTML="";
                stdNo = 0;
                TheStudent.forEach(element => {
                    AddItemToTable(element.承辦人員名字, element.承辦人員email, element.帳號, element.職稱, element.申請人電話, element.密碼);
                });
            }

            window.FillTboxes=(index)=>{
            if(index==null){
                name1.value = "";
                mail1.value = "";
                job1.value = "";
                tele1.value = "";
                acc1.value = "";
                pass1.value = "";
                SetBtn.style.display='inline-block';
                UpBtn.style.display='none';
                DelBtn.style.display='none';
            }
            else{
                --index; 
                name1.value = stdList[index][0];
                mail1.value = stdList[index][1];
                acc1.value = stdList[index][2];
                job1.value = stdList[index][3];
                tele1.value = stdList[index][4];
                pass1.value = stdList[index][5];
                acc1.disabled=true;
                SetBtn.style.display='none';
                UpBtn.style.display='inline-block';
                DelBtn.style.display='inline-block';
            }
        }

        async function set(){
       
        var ref= doc(db,"申請中-開課單位承辦人員資料", acc1.value);
  
        await setDoc(
                  ref, {
                    承辦人員名字: name1.value,
                    帳號: acc1.value,
                    密碼: pass1.value,
                    承辦人員email:mail1.value,
                    申請人電話: tele1.value,
                    職稱: job1.value,
                    開課單位名稱:openName
                  }
              )
              .then(()=>{
                  alert("新增成功");
                  window.location.reload();
              })
              .catch((error)=>{
                  alert("Unsuccessful operation, error"+error);
              });
}
        

      async function update(){
            var ref = doc(db,"申請中-開課單位承辦人員資料", acc1.value);

            await updateDoc(
                ref,{
                  承辦人員名字: name1.value,
                  帳號: acc1.value,
                  密碼: pass1.value,
                  承辦人員email:mail1.value,
                  申請人電話: tele1.value,
                  職稱: job1.value             
                 }
            )
            .then(()=>{
            alert("修改成功");
            window.location.reload();
            })
            .catch((error)=>{
                alert("Unsuccessful operation, error"+error);
            });
        }
    
            //get all data
            async function GetAllDataOnce(){
                const ref = collection(db, "申請中-開課單位承辦人員資料");
                const q = query(ref,where('開課單位名稱','==',openName));
                const querySnapshot = await getDocs(q);
    
                var students = [];
                querySnapshot.forEach(doc =>{
                    students.push(doc.data());
                });
    
                AddAllItemsToTable(students);
            }
            window.onload = function(){ storedata(); GetAllDataOnce()}


  //set the data
  //async function set(){
  //      var ref= doc(db,"申請中-開課單位承辦人員資料", job1.value);

  //      const docRef = await setDoc(
  //          ref, {
   //           承辦人員名字: name1.value,
   //           帳號: acc1.value,
   //           密碼: pass1.value,
   //           承辦人員email:mail1.value,
   //           申請人電話: tele1.value,
   //           職稱: job1.value
   //         }
   //     )
  //      .then(()=>{
   //         alert("data added successfully");
   //     })
  //      .catch((error)=>{
   //         alert("Unsuccessful operation, error"+error);
   //     });
  //    }
  async function deletedocument(){
            var ref = doc(db,"申請中-開課單位承辦人員資料", acc1.value);
            const docSnap = await getDoc(ref);

            if(!docSnap.exists()){
                alert("Document does not exists");
                return;
        }
            await deleteDoc(ref)
            .then(()=>{
            alert("刪除成功");
            window.location.reload();
            })
            .catch((error)=>{
                alert("Unsuccessful operation, error"+error);
            });
        }
        

  SetBtn.addEventListener("click",(e) =>{
    e.preventDefault();
    set();
  });
  

  UpBtn.addEventListener("click",(e) =>{
    e.preventDefault();
    update();
  });


    DelBtn.addEventListener("click",(e) =>{
    e.preventDefault();
    deletedocument();
  });

    
       
   

  

  </script>
</body>

</html>